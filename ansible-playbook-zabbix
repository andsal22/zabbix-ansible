- name: Install and configure agent
  hosts: windows_servers
  vars:
    zabbix_agent_version: "5.4.2"
    zabbix_server_ip: "185.174.168.26"
    zabbix_server_port: "10050"
  tasks:
    - name: Download Zabbix agent
      win_get_url:
        url: "https://repo.zabbix.com/zabbix/{{ zabbix_agent_version }}/windows/zabbix_agent-{{ zabbix_agent_version }}-win-amd64-openssl.msi"
        dest: C:\Temp\zabbix_agent.msi

    - name: Install Zabbix agent
      win_package:
        path: C:\Temp\zabbix_agent.msi
        product_id: "{4C3B24FA-4F7A-4A06-AC7D-1C772EBE7A5C}"
        arguments: '/qn Server={{ zabbix_server_ip }} ServerPort={{ 10050 }}'

    - name: Configure Zabbix agent
      win_template:
        src: zabbix_agentd.conf.j2
        dest: C:\Program Files\Zabbix Agent\zabbix_agentd.conf
      notify: restart zabbix agent service

  handlers:
    - name: restart Zabbix agent
      win_service:
        name: "Zabbix Agent"
        state: restarted
